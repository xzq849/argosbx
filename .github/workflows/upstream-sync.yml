# ä¸Šæ¸¸åŒæ­¥å·¥ä½œæµ - è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“çš„æ›´æ–°
name: Upstream Sync

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå³ä½¿æ²¡æœ‰æ›´æ–°ä¹ŸæŽ¨é€ï¼‰'
        required: false
        default: false
        type: boolean

# æƒé™è®¾ç½®ï¼šä½¿ç”¨æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: write
  actions: read

jobs:
  # åŒæ­¥ä¸Šæ¸¸ä»“åº“çš„ä»»åŠ¡
  sync-upstream:
    # è¿è¡ŒçŽ¯å¢ƒï¼šä½¿ç”¨æœ€æ–°çš„Ubuntuç³»ç»Ÿ
    runs-on: ubuntu-latest
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´è¿è¡Œ
    timeout-minutes: 10
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: ðŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          # ä¸ä¿å­˜å‡­æ®ï¼Œé¿å…å®‰å…¨é—®é¢˜
          persist-credentials: false
          # èŽ·å–å®Œæ•´çš„gitåŽ†å²è®°å½•
          fetch-depth: 0
          # ä½¿ç”¨GitHub Tokenè¿›è¡Œèº«ä»½éªŒè¯
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤2ï¼šé…ç½®gitç”¨æˆ·ä¿¡æ¯
      - name: âš™ï¸ é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          # è®¾ç½®gitç”¨æˆ·åä¸ºGitHub Actionsæœºå™¨äºº
          git config user.name "github-actions[bot]"
          # è®¾ç½®gité‚®ç®±ä¸ºGitHub Actionsæœºå™¨äººé‚®ç®±
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # è®¾ç½®gitå®‰å…¨é…ç½®
          git config --global --add safe.directory /github/workspace

      # æ­¥éª¤3ï¼šéªŒè¯ä¸Šæ¸¸ä»“åº“å¯è®¿é—®æ€§
      - name: ðŸ” éªŒè¯ä¸Šæ¸¸ä»“åº“
        id: check_upstream
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦å¯è®¿é—®
          if curl -s --head https://github.com/yonggekkk/argosbx | head -n 1 | grep -q "200 OK"; then
            echo "upstream_accessible=true" >> $GITHUB_OUTPUT
            echo "âœ… ä¸Šæ¸¸ä»“åº“å¯è®¿é—®"
          else
            echo "upstream_accessible=false" >> $GITHUB_OUTPUT
            echo "âŒ ä¸Šæ¸¸ä»“åº“ä¸å¯è®¿é—®"
            exit 1
          fi

      # æ­¥éª¤4ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶èŽ·å–æœ€æ–°ä»£ç 
      - name: ðŸ”— æ·»åŠ ä¸Šæ¸¸ä»“åº“
        if: steps.check_upstream.outputs.upstream_accessible == 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨upstreamè¿œç¨‹ä»“åº“
          if git remote | grep -q "^upstream$"; then
            echo "ðŸ“ upstreamè¿œç¨‹ä»“åº“å·²å­˜åœ¨ï¼Œæ›´æ–°URL"
            git remote set-url upstream https://github.com/yonggekkk/argosbx.git
          else
            echo "âž• æ·»åŠ upstreamè¿œç¨‹ä»“åº“"
            git remote add upstream https://github.com/yonggekkk/argosbx.git
          fi
          
          # ä»Žä¸Šæ¸¸ä»“åº“èŽ·å–æœ€æ–°çš„ä»£ç 
          echo "ðŸ“¡ èŽ·å–ä¸Šæ¸¸ä»“åº“æœ€æ–°ä»£ç ..."
          git fetch upstream --prune

      # æ­¥éª¤5ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      - name: ðŸ”„ æ£€æŸ¥æ›´æ–°çŠ¶æ€
        id: check_updates
        run: |
          # èŽ·å–å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤
          LOCAL_COMMIT=$(git rev-parse HEAD)
          # èŽ·å–ä¸Šæ¸¸åˆ†æ”¯çš„æœ€æ–°æäº¤
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          
          echo "æœ¬åœ°æäº¤: $LOCAL_COMMIT"
          echo "ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ°ä¸Šæ¸¸æ›´æ–°"
            
            # æ£€æŸ¥æ›´æ–°æ•°é‡
            COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main)
            echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
            echo "ðŸ“Š è½åŽ $COMMITS_BEHIND ä¸ªæäº¤"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi

      # æ­¥éª¤6ï¼šåˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼ˆæ™ºèƒ½åˆå¹¶ç­–ç•¥ï¼‰
      - name: ðŸ”€ åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        id: merge_upstream
        run: |
          echo "ðŸš€ å¼€å§‹åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
          
          # å°è¯•å¿«è¿›åˆå¹¶
          if git merge upstream/main --ff-only; then
            echo "merge_strategy=fast-forward" >> $GITHUB_OUTPUT
            echo "âœ… å¿«è¿›åˆå¹¶æˆåŠŸ"
          else
            echo "âš ï¸ æ— æ³•å¿«è¿›åˆå¹¶ï¼Œå°è¯•ä¸‰æ–¹åˆå¹¶..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
            if git merge upstream/main --no-edit; then
              echo "merge_strategy=three-way" >> $GITHUB_OUTPUT
              echo "âœ… ä¸‰æ–¹åˆå¹¶æˆåŠŸ"
            else
              echo "âŒ åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
              echo "merge_strategy=conflict" >> $GITHUB_OUTPUT
              
              # æ˜¾ç¤ºå†²çªæ–‡ä»¶
              echo "å†²çªæ–‡ä»¶åˆ—è¡¨ï¼š"
              git diff --name-only --diff-filter=U
              
              # ä¸­æ­¢åˆå¹¶
              git merge --abort
              exit 1
            fi
          fi

      # æ­¥éª¤7ï¼šéªŒè¯åˆå¹¶ç»“æžœ
      - name: âœ… éªŒè¯åˆå¹¶ç»“æžœ
        if: steps.merge_upstream.outcome == 'success'
        run: |
          echo "ðŸ” éªŒè¯åˆå¹¶ç»“æžœ..."
          
          # æ£€æŸ¥å·¥ä½œç›®å½•æ˜¯å¦å¹²å‡€
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… å·¥ä½œç›®å½•å¹²å‡€"
          else
            echo "âš ï¸ å·¥ä½œç›®å½•æœ‰æœªæäº¤çš„æ›´æ”¹"
            git status
          fi
          
          # æ˜¾ç¤ºæœ€æ–°çš„å‡ ä¸ªæäº¤
          echo "ðŸ“ æœ€æ–°æäº¤åŽ†å²ï¼š"
          git log --oneline -5

      # æ­¥éª¤8ï¼šæŽ¨é€æ›´æ”¹åˆ°å½“å‰ä»“åº“
      - name: ðŸ“¤ æŽ¨é€æ›´æ”¹
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ æŽ¨é€æ›´æ”¹åˆ°originä»“åº“..."
          
          # è®¾ç½®è¿œç¨‹ä»“åº“URLï¼ˆä½¿ç”¨tokenè®¤è¯ï¼‰
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          # æŽ¨é€åˆ°mainåˆ†æ”¯
          if git push origin main; then
            echo "âœ… æŽ¨é€æˆåŠŸ"
          else
            echo "âŒ æŽ¨é€å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤9ï¼šç”ŸæˆåŒæ­¥æŠ¥å‘Š
      - name: ðŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ”„ ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸ä»“åº“:** https://github.com/yonggekkk/argosbx" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_updates.outputs.has_updates }}" == "true" ]; then
            echo "**æ›´æ–°çŠ¶æ€:** âœ… å‘çŽ°å¹¶å¤„ç†äº† ${{ steps.check_updates.outputs.commits_behind }} ä¸ªæ–°æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "**åˆå¹¶ç­–ç•¥:** ${{ steps.merge_upstream.outputs.merge_strategy }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ›´æ–°çŠ¶æ€:** â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**å·¥ä½œæµçŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY