# ä¸Šæ¸¸åŒæ­¥å·¥ä½œæµ - è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“çš„æ›´æ–°
name: Upstream Sync

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå³ä½¿æ²¡æœ‰æ›´æ–°ä¹ŸæŽ¨é€ï¼‰'
        required: false
        default: false
        type: boolean

# æƒé™è®¾ç½®ï¼šä½¿ç”¨æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: write
  actions: read

jobs:
  # åŒæ­¥ä¸Šæ¸¸ä»“åº“çš„ä»»åŠ¡
  sync-upstream:
    # è¿è¡ŒçŽ¯å¢ƒï¼šä½¿ç”¨æœ€æ–°çš„Ubuntuç³»ç»Ÿ
    runs-on: ubuntu-latest
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´è¿è¡Œ
    timeout-minutes: 10
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: ðŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          # ä¸ä¿å­˜å‡­æ®ï¼Œé¿å…å®‰å…¨é—®é¢˜
          persist-credentials: false
          # èŽ·å–å®Œæ•´çš„gitåŽ†å²è®°å½•
          fetch-depth: 0
          # ä½¿ç”¨GitHub Tokenè¿›è¡Œèº«ä»½éªŒè¯
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤2ï¼šé…ç½®gitç”¨æˆ·ä¿¡æ¯
      - name: âš™ï¸ é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          # è®¾ç½®gitç”¨æˆ·åä¸ºGitHub Actionsæœºå™¨äºº
          git config user.name "github-actions[bot]"
          # è®¾ç½®gité‚®ç®±ä¸ºGitHub Actionsæœºå™¨äººé‚®ç®±
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # è®¾ç½®gitå®‰å…¨é…ç½®
          git config --global --add safe.directory /github/workspace

      # æ­¥éª¤3ï¼šç½‘ç»œè¯Šæ–­å’Œä¸Šæ¸¸ä»“åº“éªŒè¯
      - name: ðŸ” ç½‘ç»œè¯Šæ–­å’Œä»“åº“éªŒè¯
        id: check_upstream
        run: |
          echo "ðŸ” å¼€å§‹ç½‘ç»œè¯Šæ–­å’Œä¸Šæ¸¸ä»“åº“éªŒè¯..."
          
          # ç½‘ç»œåŸºç¡€è¿žæŽ¥æµ‹è¯•
          echo "ðŸ“¡ æµ‹è¯•ç½‘ç»œè¿žæŽ¥..."
          if ping -c 2 github.com >/dev/null 2>&1; then
            echo "âœ… GitHubç½‘ç»œè¿žæŽ¥æ­£å¸¸"
          else
            echo "âš ï¸ GitHubç½‘ç»œè¿žæŽ¥å¯èƒ½æœ‰é—®é¢˜"
          fi
          
          # DNSè§£æžæµ‹è¯•
          echo "ðŸ” æµ‹è¯•DNSè§£æž..."
          if nslookup github.com >/dev/null 2>&1; then
            echo "âœ… DNSè§£æžæ­£å¸¸"
          else
            echo "âš ï¸ DNSè§£æžå¯èƒ½æœ‰é—®é¢˜"
          fi
          
          # æ–¹æ³•1ï¼šä½¿ç”¨curlæ£€æŸ¥ä»“åº“é¡µé¢ï¼ˆæœ€å¯é ï¼‰
          echo "ðŸŒ æ–¹æ³•1: HTTPæ£€æŸ¥ä»“åº“é¡µé¢..."
          if curl -s -f -I "https://github.com/yonggekkk/argosbx" >/dev/null 2>&1; then
            echo "âœ… HTTPæ£€æŸ¥æˆåŠŸ - ä»“åº“å­˜åœ¨"
            echo "upstream_accessible=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ HTTPæ£€æŸ¥å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
            
            # æ–¹æ³•2ï¼šä½¿ç”¨GitHub APIæ£€æŸ¥
            echo "ðŸ” æ–¹æ³•2: GitHub APIæ£€æŸ¥..."
            if curl -s "https://api.github.com/repos/yonggekkk/argosbx" | grep -q '"name"'; then
              echo "âœ… GitHub APIæ£€æŸ¥æˆåŠŸ - ä»“åº“å­˜åœ¨"
              echo "upstream_accessible=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ GitHub APIæ£€æŸ¥å¤±è´¥ï¼Œå°è¯•Gitæ£€æŸ¥..."
              
              # æ–¹æ³•3ï¼šä½¿ç”¨Git ls-remoteæ£€æŸ¥ï¼ˆå¯èƒ½å—ç½‘ç»œé™åˆ¶å½±å“ï¼‰
              echo "ðŸ” æ–¹æ³•3: Git ls-remoteæ£€æŸ¥..."
              if timeout 30 git ls-remote --heads https://github.com/yonggekkk/argosbx.git >/dev/null 2>&1; then
                echo "âœ… Git ls-remoteæ£€æŸ¥æˆåŠŸ"
                echo "upstream_accessible=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ æ‰€æœ‰æ£€æŸ¥æ–¹æ³•éƒ½å¤±è´¥äº†"
                echo "upstream_accessible=false" >> $GITHUB_OUTPUT
                
                echo "ðŸ”§ è¯Šæ–­ä¿¡æ¯ï¼š"
                echo "   1. ä»“åº“å¯èƒ½å·²è¢«åˆ é™¤æˆ–è®¾ä¸ºç§æœ‰"
                echo "   2. ç½‘ç»œè¿žæŽ¥æˆ–é˜²ç«å¢™é—®é¢˜"
                echo "   3. GitHubæœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
                echo "   4. Gitåè®®è¢«é˜»æ­¢"
                
                echo "âš ï¸ å°†å°è¯•ç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨å®¹é”™æ¨¡å¼"
              fi
            fi
          fi

      # æ­¥éª¤4ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶èŽ·å–æœ€æ–°ä»£ç 
      - name: ðŸ”— æ·»åŠ ä¸Šæ¸¸ä»“åº“
        id: add_upstream
        continue-on-error: true
        run: |
          echo "ðŸ”— é…ç½®ä¸Šæ¸¸ä»“åº“..."
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨upstreamè¿œç¨‹ä»“åº“
          if git remote | grep -q "^upstream$"; then
            echo "ðŸ“ upstreamè¿œç¨‹ä»“åº“å·²å­˜åœ¨ï¼Œæ›´æ–°URL"
            git remote set-url upstream https://github.com/yonggekkk/argosbx.git
          else
            echo "âž• æ·»åŠ upstreamè¿œç¨‹ä»“åº“"
            git remote add upstream https://github.com/yonggekkk/argosbx.git
          fi
          
          # éªŒè¯è¿œç¨‹ä»“åº“é…ç½®
          echo "ðŸ” éªŒè¯è¿œç¨‹ä»“åº“é…ç½®ï¼š"
          git remote -v
          
          # ä»Žä¸Šæ¸¸ä»“åº“èŽ·å–æœ€æ–°çš„ä»£ç ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          echo "ðŸ“¡ èŽ·å–ä¸Šæ¸¸ä»“åº“æœ€æ–°ä»£ç ..."
          
          # å°è¯•èŽ·å–ä»£ç ï¼Œæœ€å¤šé‡è¯•3æ¬¡
          for i in {1..3}; do
            echo "ðŸ”„ å°è¯•ç¬¬ $i æ¬¡èŽ·å–..."
            if git fetch upstream --prune; then
              echo "âœ… æˆåŠŸèŽ·å–ä¸Šæ¸¸ä»£ç "
              echo "fetch_success=true" >> $GITHUB_OUTPUT
              break
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡èŽ·å–å¤±è´¥"
              if [ $i -eq 3 ]; then
                echo "âŒ æ‰€æœ‰èŽ·å–å°è¯•éƒ½å¤±è´¥äº†"
                echo "fetch_success=false" >> $GITHUB_OUTPUT
                
                # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                echo "ðŸ”§ æ•…éšœæŽ’é™¤ä¿¡æ¯ï¼š"
                echo "   - æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦å­˜åœ¨: https://github.com/yonggekkk/argosbx"
                echo "   - æ£€æŸ¥ç½‘ç»œè¿žæŽ¥"
                echo "   - æ£€æŸ¥ä»“åº“æƒé™"
                
                exit 1
              else
                echo "â³ ç­‰å¾…5ç§’åŽé‡è¯•..."
                sleep 5
              fi
            fi
          done

      # æ­¥éª¤5ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      - name: ðŸ”„ æ£€æŸ¥æ›´æ–°çŠ¶æ€
        id: check_updates
        if: steps.add_upstream.outputs.fetch_success == 'true'
        run: |
          # èŽ·å–å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤
          LOCAL_COMMIT=$(git rev-parse HEAD)
          # èŽ·å–ä¸Šæ¸¸åˆ†æ”¯çš„æœ€æ–°æäº¤
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          
          echo "æœ¬åœ°æäº¤: $LOCAL_COMMIT"
          echo "ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ°ä¸Šæ¸¸æ›´æ–°"
            
            # æ£€æŸ¥æ›´æ–°æ•°é‡
            COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main)
            echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
            echo "ðŸ“Š è½åŽ $COMMITS_BEHIND ä¸ªæäº¤"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi

      # æ­¥éª¤6ï¼šåˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼ˆæ™ºèƒ½åˆå¹¶ç­–ç•¥ï¼‰
      - name: ðŸ”€ åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        id: merge_upstream
        run: |
          echo "ðŸš€ å¼€å§‹åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
          
          # å°è¯•å¿«è¿›åˆå¹¶
          if git merge upstream/main --ff-only; then
            echo "merge_strategy=fast-forward" >> $GITHUB_OUTPUT
            echo "âœ… å¿«è¿›åˆå¹¶æˆåŠŸ"
          else
            echo "âš ï¸ æ— æ³•å¿«è¿›åˆå¹¶ï¼Œå°è¯•ä¸‰æ–¹åˆå¹¶..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
            if git merge upstream/main --no-edit; then
              echo "merge_strategy=three-way" >> $GITHUB_OUTPUT
              echo "âœ… ä¸‰æ–¹åˆå¹¶æˆåŠŸ"
            else
              echo "âŒ åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
              echo "merge_strategy=conflict" >> $GITHUB_OUTPUT
              
              # æ˜¾ç¤ºå†²çªæ–‡ä»¶
              echo "å†²çªæ–‡ä»¶åˆ—è¡¨ï¼š"
              git diff --name-only --diff-filter=U
              
              # ä¸­æ­¢åˆå¹¶
              git merge --abort
              exit 1
            fi
          fi

      # æ­¥éª¤7ï¼šéªŒè¯åˆå¹¶ç»“æžœ
      - name: âœ… éªŒè¯åˆå¹¶ç»“æžœ
        if: steps.merge_upstream.outcome == 'success'
        run: |
          echo "ðŸ” éªŒè¯åˆå¹¶ç»“æžœ..."
          
          # æ£€æŸ¥å·¥ä½œç›®å½•æ˜¯å¦å¹²å‡€
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… å·¥ä½œç›®å½•å¹²å‡€"
          else
            echo "âš ï¸ å·¥ä½œç›®å½•æœ‰æœªæäº¤çš„æ›´æ”¹"
            git status
          fi
          
          # æ˜¾ç¤ºæœ€æ–°çš„å‡ ä¸ªæäº¤
          echo "ðŸ“ æœ€æ–°æäº¤åŽ†å²ï¼š"
          git log --oneline -5

      # æ­¥éª¤8ï¼šæŽ¨é€æ›´æ”¹åˆ°å½“å‰ä»“åº“
      - name: ðŸ“¤ æŽ¨é€æ›´æ”¹
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ æŽ¨é€æ›´æ”¹åˆ°originä»“åº“..."
          
          # è®¾ç½®è¿œç¨‹ä»“åº“URLï¼ˆä½¿ç”¨tokenè®¤è¯ï¼‰
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          # æŽ¨é€åˆ°mainåˆ†æ”¯
          if git push origin main; then
            echo "âœ… æŽ¨é€æˆåŠŸ"
          else
            echo "âŒ æŽ¨é€å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤9ï¼šç”ŸæˆåŒæ­¥æŠ¥å‘Š
      - name: ðŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ”„ ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸ä»“åº“:** https://github.com/yonggekkk/argosbx" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_updates.outputs.has_updates }}" == "true" ]; then
            echo "**æ›´æ–°çŠ¶æ€:** âœ… å‘çŽ°å¹¶å¤„ç†äº† ${{ steps.check_updates.outputs.commits_behind }} ä¸ªæ–°æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "**åˆå¹¶ç­–ç•¥:** ${{ steps.merge_upstream.outputs.merge_strategy }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ›´æ–°çŠ¶æ€:** â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**å·¥ä½œæµçŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY